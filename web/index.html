<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stellantis OAuth Helper</title>
<style>
:root {
  --bg: #f7f7f9;
  --panel: #fff;
  --text: #222;
  --text-light: #666;
  --border: #ddd;
  --primary: #2563eb;
  --primary-hover: #1d4ed8;
  --radius: 8px;
  --font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
  background: var(--bg);
  font-family: var(--font);
  color: var(--text);
}

.container {
  max-width: 820px;
  margin: 40px auto;
  padding: 40px;
  background: var(--panel);
  border-radius: var(--radius);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.07);
}

h1 {
  margin-top: 0;
  font-size: 30px;
  font-weight: 700;
}

p {
  color: var(--text-light);
  line-height: 1.6;
}

label {
  display: block;
  margin-top: 22px;
  font-weight: 600;
  margin-bottom: 6px;
}

input, select {
  width: 100%;
  padding: 10px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: #fafafa;
  font-size: 16px;
}

input:focus, select:focus {
  outline: none;
  border-color: var(--primary);
}

button {
  margin-top: 26px;
  padding: 12px 22px;
  background: var(--primary);
  border: none;
  color: #fff;
  font-size: 16px;
  font-weight: 600;
  border-radius: var(--radius);
  cursor: pointer;
  width: 100%;
}

button:hover {
  background: var(--primary-hover);
}

button:disabled {
  background: #94a3b8;
  cursor: not-allowed;
}

.section-title {
  margin-top: 42px;
  font-weight: 700;
  font-size: 22px;
}

#result {
  margin-top: 16px;
  padding: 14px 18px;
  border-radius: var(--radius);
  font-family: monospace;
  white-space: pre-wrap;
  word-break: break-all;
  background: #f1f3f5;
}

.alert-error {
  background: #fee2e2 !important;
  color: #b91c1c !important;
  border: 1px solid #fca5a5 !important;
}

.alert-success {
  background: #e0fce5 !important;
  color: #166534 !important;
  border: 1px solid #86efac !important;
}

.alert-info {
  background: #eef2ff !important;
  color: #3730a3 !important;
  border: 1px solid #c7d2fe !important;
}

.copy-btn {
  margin-top: 12px;
  padding: 8px 16px;
  font-size: 14px;
  width: auto;
  display: none;
}

.copy-btn.visible {
  display: inline-block;
}

footer {
  margin-top: 30px;
  text-align: center;
  color: var(--text-light);
  font-size: 14px;
}

footer a {
  color: var(--primary);
  text-decoration: none;
}

footer a:hover {
  text-decoration: underline;
}
</style>
</head>
<body>
<div class="container">
  <h1>Stellantis OAuth Helper</h1>
  <p>
    Use this tool to authenticate with Stellantis and retrieve the OAuth code required for vehicle integrations.<br>
    Your credentials remain private â€” nothing is stored or kept after the login completes.
  </p>

  <label for="brand">Brand:</label>
  <select id="brand"></select>

  <label for="country">Country:</label>
  <select id="country"></select>

  <label for="email">Email:</label>
  <input id="email" type="email" placeholder="your@email.com">

  <label for="password">Password:</label>
  <input id="password" type="password" placeholder="Your password">

  <button id="submitBtn" onclick="startOAuth()">Get OAuth Code</button>

  <div class="section-title">Result</div>
  <div id="result">(waiting)</div>
  <button id="copyBtn" class="copy-btn" onclick="copyCode()">Copy Code</button>

  <footer>
    <a href="https://github.com/tamcore/stelloauth" target="_blank">View on GitHub</a>
  </footer>
</div>

<script>
let configs = {};
let lastCode = '';

async function loadConfigs() {
  try {
    const r = await fetch('/configs');
    configs = await r.json();
    
    const brandSelect = document.getElementById('brand');
    const countrySelect = document.getElementById('country');
    
    brandSelect.innerHTML = '';
    for (const brand of Object.keys(configs).sort()) {
      if (configs[brand].configs) {
        brandSelect.innerHTML += `<option value="${brand}">${brand}</option>`;
      }
    }
    
    brandSelect.addEventListener('change', updateCountries);
    updateCountries();
  } catch (e) {
    document.getElementById('result').className = 'alert-error';
    document.getElementById('result').innerText = 'Failed to load configuration: ' + e.message;
  }
}

function updateCountries() {
  const brand = document.getElementById('brand').value;
  const countrySelect = document.getElementById('country');
  
  countrySelect.innerHTML = '';
  if (configs[brand] && configs[brand].configs) {
    for (const country of Object.keys(configs[brand].configs).sort()) {
      countrySelect.innerHTML += `<option value="${country}">${country}</option>`;
    }
  }
}

async function startOAuth() {
  const btn = document.getElementById('submitBtn');
  const box = document.getElementById('result');
  const copyBtn = document.getElementById('copyBtn');
  
  btn.disabled = true;
  btn.innerText = 'Processing...';
  box.className = 'alert-info';
  box.innerText = 'Starting...';
  copyBtn.classList.remove('visible');
  lastCode = '';

  const payload = {
    brand: document.getElementById('brand').value,
    country: document.getElementById('country').value,
    email: document.getElementById('email').value,
    password: document.getElementById('password').value
  };

  try {
    const response = await fetch('/oauth', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'text/event-stream'
      },
      body: JSON.stringify(payload)
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const text = decoder.decode(value);
      const lines = text.split('\n');
      
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          try {
            const data = JSON.parse(line.slice(6));
            if (data.type === 'progress') {
              box.innerText = data.message;
            } else if (data.type === 'error') {
              box.className = 'alert-error';
              box.innerText = 'Error: ' + data.message;
            } else if (data.type === 'success') {
              box.className = 'alert-success';
              box.innerText = 'OAuth Code:\n' + data.code;
              lastCode = data.code;
              copyBtn.classList.add('visible');
            }
          } catch (e) {}
        }
      }
    }
  } catch (e) {
    box.className = 'alert-error';
    box.innerText = 'Request failed: ' + e.message;
  }

  btn.disabled = false;
  btn.innerText = 'Get OAuth Code';
}

function copyCode() {
  if (lastCode) {
    navigator.clipboard.writeText(lastCode).then(() => {
      const btn = document.getElementById('copyBtn');
      btn.innerText = 'Copied!';
      setTimeout(() => { btn.innerText = 'Copy Code'; }, 2000);
    });
  }
}

loadConfigs();
</script>
</body>
</html>
